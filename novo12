-- =============================================
-- SISTEMA DO OLHO GIGANTE - DEBUG MODE
-- =============================================

print("=== INICIANDO SISTEMA OLHO DEBUG ===")

-- Função segura para pegar telas
local function carregarTelas()
    print("1. Procurando telas...")
    local telas = {peripheral.find("monitor")}
    print("2. Telas brutas encontradas: " .. #telas)
    
    -- Se não encontrou nada, tenta método alternativo
    if #telas == 0 then
        print("3. Tentando método alternativo...")
        telas = {}
        local lados = {"top", "bottom", "left", "right", "front", "back"}
        for _, lado in ipairs(lados) do
            if peripheral.isPresent(lado) and peripheral.getType(lado) == "monitor" then
                local tela = peripheral.wrap(lado)
                table.insert(telas, tela)
                print("   Tela encontrada no lado: " .. lado)
            end
        end
    end
    
    -- Corrigir se for uma única tela
    if #telas == 1 and telas[1] == nil then
        telas = {}
    end
    
    print("4. Total de telas válidas: " .. #telas)
    return telas
end

-- Carregar telas
local telas = carregarTelas()

if #telas == 0 then
    print("ERRO: Nenhuma tela encontrada!")
    print("Conecte monitores e use:")
    print("  peripheral.find('monitor')")
    print("Reiniciando em 5 segundos...")
    os.sleep(5)
    return
end

-- Configurar telas
print("5. Configurando telas...")
for i, tela in ipairs(telas) do
    local ok, err = pcall(function()
        tela.setTextScale(0.5)
        tela.setBackgroundColor(colors.black)
        tela.clear()
        print("   Tela " .. i .. " configurada")
    end)
    
    if not ok then
        print("   ERRO na tela " .. i .. ": " .. err)
    end
end

-- Sistema do Olho
local larguraTotal, alturaTotal = 0, 0
local tempo = 0

-- Organizar telas de forma SIMPLES
function organizarTelas()
    print("6. Organizando telas...")
    
    local larguraTela, alturaTela = 8, 5
    local x, y = 1, 1
    
    for i, tela in ipairs(telas) do
        tela.posX = x
        tela.posY = y
        tela.largura = larguraTela
        tela.altura = alturaTela
        
        larguraTotal = math.max(larguraTotal, x + larguraTela - 1)
        alturaTotal = math.max(alturaTotal, y + alturaTela - 1)
        
        x = x + larguraTela + 1
        
        -- Quebra linha a cada 3 telas
        if i % 3 == 0 then
            x = 1
            y = y + alturaTela + 1
        end
    end
    
    print("7. Grid criado: " .. larguraTotal .. "x" .. alturaTotal)
end

-- Limpar telas
function limparTodasTelas()
    for i, tela in ipairs(telas) do
        pcall(function()
            tela.setBackgroundColor(colors.black)
            tela.clear()
        end)
    end
end

-- Desenhar pixel SIMPLES
function desenharPixel(xGlobal, yGlobal, cor)
    for i, tela in ipairs(telas) do
        if xGlobal >= tela.posX and xGlobal < tela.posX + tela.largura and
           yGlobal >= tela.posY and yGlobal < tela.posY + tela.altura then
            
            local xLocal = xGlobal - tela.posX + 1
            local yLocal = yGlobal - tela.posY + 1
            
            local ok, err = pcall(function()
                tela.setBackgroundColor(cor)
                tela.setCursorPos(xLocal, yLocal)
                tela.write(" ")
            end)
            
            if not ok then
                print("ERRO ao desenhar: " .. err)
            end
            
            return true
        end
    end
    return false
end

-- Olho SIMPLES
function desenharOlho(xGlobal, yGlobal)
    limparTodasTelas()
    
    -- Olho básico quadrado para teste
    for x = -2, 2 do
        for y = -1, 1 do
            desenharPixel(xGlobal + x, yGlobal + y, colors.white)
        end
    end
    
    -- Pupila
    desenharPixel(xGlobal, yGlobal, colors.black)
end

-- Movimento SIMPLES
function movimentoTeste(t)
    local x = (t * 2) % (larguraTotal - 4) + 2
    local y = alturaTotal / 2
    return math.floor(x), math.floor(y)
end

-- Animação TESTE
function executarTeste()
    print("8. Iniciando teste...")
    print("Pressione Ctrl+T para parar")
    
    local contador = 0
    while contador < 50 do  -- Só 50 frames para teste
        local x, y = movimentoTeste(tempo)
        
        x = math.max(3, math.min(larguraTotal - 2, x))
        y = math.max(2, math.min(alturaTotal - 1, y))
        
        desenharOlho(x, y)
        
        tempo = tempo + 0.1
        contador = contador + 1
        os.sleep(0.2)
    end
    
    print("9. Teste concluído!")
    print("Se funcionou, o olho moveu por todas as telas")
end

-- Programa principal SEGURO
print("=== INICIANDO PROGRAMA PRINCIPAL ===")
organizarTelas()
executarTeste()

print("=== FIM DO PROGRAMA ===")
print("Se chegou aqui, o básico funciona!")
