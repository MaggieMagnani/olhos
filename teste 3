-- =============================================
-- SISTEMA COMPLETO + CONTROLE DE VELOCIDADE
-- =============================================

print("=== SISTEMA COM VELOCIDADE ===")

-- Pega TODAS as telas
local telas = {peripheral.find("monitor")}
if not telas[1] then telas = {telas} end

print("Telas detectadas: " .. #telas)

-- Configura todas as telas
for i, tela in ipairs(telas) do
    tela.setTextScale(0.5)
end

-- MODOS DE COR disponÃ­veis
local modosCor = {
    ["Branco"] = {
        cores = {colors.white},
        descricao = "âšª Branco puro - estilo Daft Punk"
    },
    ["ColoridoAleatorio"] = {
        cores = {
            colors.red, colors.orange, colors.yellow,
            colors.lime, colors.green, colors.cyan,
            colors.lightBlue, colors.blue, colors.purple,
            colors.pink, colors.magenta
        },
        descricao = "ðŸŒˆ Cores aleatÃ³rias - festivo"
    },
    ["CorSolida"] = {
        cores = {
            colors.red, colors.orange, colors.yellow,
            colors.lime, colors.green, colors.cyan,
            colors.blue, colors.purple, colors.pink
        },
        descricao = "ðŸŽ¨ Uma cor sÃ³lida por vez - elegante"
    }
}

-- VELOCIDADES disponÃ­veis
local velocidades = {
    ["Lenta"] = {
        multiplicador = 2.0,
        descricao = "ðŸ¢ Lenta - mÃºsicas calmas/romÃ¢nticas"
    },
    ["Media"] = {
        multiplicador = 1.0,
        descricao = "ðŸš¶ MÃ©dia - padrÃ£o balada"
    },
    ["Rapida"] = {
        multiplicador = 0.5,
        descricao = "ðŸƒ RÃ¡pida - pop/energÃ©tico"
    },
    ["Eletronica"] = {
        multiplicador = 0.25,
        descricao = "âš¡ EletrÃ´nica - batidas aceleradas"
    }
}

-- VariÃ¡veis globais
local modoCorAtual = "Branco"
local velocidadeAtual = "Media"
local corSolidaAtual = colors.red

-- FunÃ§Ã£o para obter cor baseada no modo atual
function obterCor(telaIndex, efeitoData)
    if modoCorAtual == "Branco" then
        return colors.white
        
    elseif modoCorAtual == "ColoridoAleatorio" then
        return modosCor.ColoridoAleatorio.cores[
            math.random(1, #modosCor.ColoridoAleatorio.cores)
        ]
        
    elseif modoCorAtual == "CorSolida" then
        return corSolidaAtual
    end
    
    return colors.white
end

-- FunÃ§Ã£o para aplicar velocidade
function aplicarVelocidade(tempoBase)
    return tempoBase * velocidades[velocidadeAtual].multiplicador
end

-- EFEITO 1: PULSO SEQUENCIAL
function pulsoSequencial()
    print("Pulso Sequencial")
    print("Modo: " .. modoCorAtual .. " | Velocidade: " .. velocidadeAtual)
    
    local telaAtiva = 1
    
    while true do
        -- Apaga todas
        for i, tela in ipairs(telas) do
            tela.setBackgroundColor(colors.black)
            tela.clear()
        end
        
        -- Acende uma tela com a cor do modo atual
        local cor = obterCor(telaAtiva)
        telas[telaAtiva].setBackgroundColor(cor)
        telas[telaAtiva].clear()
        
        -- PrÃ³xima tela
        telaAtiva = telaAtiva + 1
        if telaAtiva > #telas then telaAtiva = 1 end
        
        os.sleep(aplicarVelocidade(0.3))
    end
end

-- EFEITO 2: ONDA
function onda()
    print("Onda")
    print("Modo: " .. modoCorAtual .. " | Velocidade: " .. velocidadeAtual)
    
    local posicao = 0
    
    while true do
        posicao = posicao + 1
        
        for i, tela in ipairs(telas) do
            tela.setBackgroundColor(colors.black)
            tela.clear()
            
            local deveAcender = (posicao % #telas) + 1 == i
            
            if deveAcender then
                local cor = obterCor(i)
                tela.setBackgroundColor(cor)
                tela.clear()
            end
        end
        
        os.sleep(aplicarVelocidade(0.2))
    end
end

-- EFEITO 3: RESPIRAÃ‡ÃƒO
function respiracao()
    print("RespiraÃ§Ã£o")
    print("Modo: " .. modoCorAtual .. " | Velocidade: " .. velocidadeAtual)
    
    while true do
        -- Acende todas com a cor do modo
        local cor = obterCor(1)
        for i, tela in ipairs(telas) do
            tela.setBackgroundColor(cor)
            tela.clear()
        end
        
        os.sleep(aplicarVelocidade(0.8))
        
        -- Apaga
        for i, tela in ipairs(telas) do
            tela.setBackgroundColor(colors.black)
            tela.clear()
        end
        
        os.sleep(aplicarVelocidade(0.4))
    end
end

-- EFEITO 4: BARRAS VERTICAIS
function barrasVerticais()
    print("Barras Verticais")
    print("Modo: " .. modoCorAtual .. " | Velocidade: " .. velocidadeAtual)
    
    local offset = 0
    
    while true do
        offset = offset + 1
        
        for i, tela in ipairs(telas) do
            local w, h = tela.getSize()
            tela.setBackgroundColor(colors.black)
            tela.clear()
            
            for barra = 1, 2 do
                local x = (offset + barra * 4 + i * 2) % w + 1
                local cor = obterCor(i)
                
                for y = 1, h do
                    tela.setBackgroundColor(cor)
                    tela.setCursorPos(x, y)
                    tela.write(" ")
                end
            end
        end
        
        os.sleep(aplicarVelocidade(0.15))
    end
end

-- EFEITO 5: PONTOS SEQUENCIAIS
function pontosSequenciais()
    print("Pontos Sequenciais")
    print("Modo: " .. modoCorAtual .. " | Velocidade: " .. velocidadeAtual)
    
    local tempo = 0
    
    while true do
        tempo = tempo + 1
        
        for i, tela in ipairs(telas) do
            local w, h = tela.getSize()
            tela.setBackgroundColor(colors.black)
            tela.clear()
            
            if (tempo % #telas) + 1 == i then
                local x = math.floor(w / 2)
                local y = math.floor(h / 2)
                local cor = obterCor(i)
                
                tela.setBackgroundColor(cor)
                tela.setCursorPos(x, y)
                tela.write(" ")
                
                tela.setCursorPos(x + 1, y)
                tela.write(" ")
                tela.setCursorPos(x - 1, y)
                tela.write(" ")
            end
        end
        
        os.sleep(aplicarVelocidade(0.25))
    end
end

-- EFEITO 6: GRADIENTE
function gradient()
    print("Gradiente")
    print("Modo: " .. modoCorAtual .. " | Velocidade: " .. velocidadeAtual)
    
    local tons = {}
    
    if modoCorAtual == "Branco" then
        tons = {colors.black, colors.gray, colors.lightGray, colors.white}
    else
        local corBase = obterCor(1)
        tons = {colors.black, colors.gray, corBase, colors.white}
    end
    
    local posicao = 0
    
    while true do
        posicao = posicao + 1
        
        for i, tela in ipairs(telas) do
            local w, h = tela.getSize()
            
            for x = 1, w do
                local progresso = (x + posicao + i * 3) % #tons
                local cor = tons[progresso + 1]
                
                for y = 1, h do
                    tela.setBackgroundColor(cor)
                    tela.setCursorPos(x, y)
                    tela.write(" ")
                end
            end
        end
        
        os.sleep(aplicarVelocidade(0.1))
    end
end

-- EFEITO 7: PISCADA ALEATÃ“RIA
function piscadaAleatoria()
    print("Piscada AleatÃ³ria")
    print("Modo: " .. modoCorAtual .. " | Velocidade: " .. velocidadeAtual)
    
    while true do
        -- Apaga tudo
        for i, tela in ipairs(telas) do
            tela.setBackgroundColor(colors.black)
            tela.clear()
        end
        
        -- Acende algumas telas
        local maxTelas = math.max(1, #telas - 1)
        local telasParaAcender = math.random(1, maxTelas)
        
        for a = 1, telasParaAcender do
            local telaAleatoria = math.random(1, #telas)
            local cor = obterCor(telaAleatoria)
            telas[telaAleatoria].setBackgroundColor(cor)
            telas[telaAleatoria].clear()
        end
        
        os.sleep(aplicarVelocidade(0.4))
        
        -- Apaga
        for i, tela in ipairs(telas) do
            tela.setBackgroundColor(colors.black)
            tela.clear()
        end
        
        os.sleep(aplicarVelocidade(0.3))
    end
end

-- EFEITO 8: GRUPOS SEQUENCIAIS
function gruposSequenciais()
    print("Grupos Sequenciais")
    print("Modo: " .. modoCorAtual .. " | Velocidade: " .. velocidadeAtual)
    
    local grupoAtual = 1
    local telasPorGrupo = math.max(1, math.floor(#telas / 3))
    
    while true do
        -- Apaga tudo
        for i, tela in ipairs(telas) do
            tela.setBackgroundColor(colors.black)
            tela.clear()
        end
        
        -- Acende um grupo
        local inicio = (grupoAtual - 1) * telasPorGrupo + 1
        local fim = math.min(grupoAtual * telasPorGrupo, #telas)
        
        for i = inicio, fim do
            if telas[i] then
                local cor = obterCor(i)
                telas[i].setBackgroundColor(cor)
                telas[i].clear()
            end
        end
        
        -- PrÃ³ximo grupo
        grupoAtual = grupoAtual + 1
        if grupoAtual > math.ceil(#telas / telasPorGrupo) then
            grupoAtual = 1
        end
        
        os.sleep(aplicarVelocidade(0.5))
    end
end

-- MENU DE SELEÃ‡ÃƒO DE VELOCIDADE
function menuVelocidade()
    print("\n" .. string.rep("=", 45))
    print("SELECIONE A VELOCIDADE DOS EFEITOS")
    print(string.rep("=", 45))
    print("1. ðŸ¢ LENTA - MÃºsicas calmas/romÃ¢nticas")
    print("2. ðŸš¶ MÃ‰DIA - PadrÃ£o balada")
    print("3. ðŸƒ RÃPIDA - Pop/energÃ©tico") 
    print("4. âš¡ ELETRÃ”NICA - Batidas aceleradas")
    print(string.rep("=", 45))
    
    write("Escolha a velocidade (1-4): ")
    local escolha = read()
    
    if escolha == "1" then
        velocidadeAtual = "Lenta"
        print("Velocidade selecionada: ðŸ¢ LENTA")
    elseif escolha == "2" then
        velocidadeAtual = "Media" 
        print("Velocidade selecionada: ðŸš¶ MÃ‰DIA")
    elseif escolha == "3" then
        velocidadeAtual = "Rapida"
        print("Velocidade selecionada: ðŸƒ RÃPIDA")
    elseif escolha == "4" then
        velocidadeAtual = "Eletronica"
        print("Velocidade selecionada: âš¡ ELETRÃ”NICA")
    else
        print("Velocidade mantida: " .. velocidadeAtual)
    end
    
    os.sleep(1)
end

-- MENU DE SELEÃ‡ÃƒO DE CORES
function menuCores()
    print("\n" .. string.rep("=", 40))
    print("SELECIONE O MODO DE CORES")
    print(string.rep("=", 40))
    print("1. âšª Branco & Preto (Daft Punk)")
    print("2. ðŸŒˆ Colorido AleatÃ³rio (Festivo)")
    print("3. ðŸŽ¨ Cor SÃ³lida (Elegante)")
    print(string.rep("=", 40))
    
    write("Escolha o modo de cores (1-3): ")
    local escolha = read()
    
    if escolha == "1" then
        modoCorAtual = "Branco"
        print("Modo selecionado: âšª Branco & Preto")
        
    elseif escolha == "2" then
        modoCorAtual = "ColoridoAleatorio"
        print("Modo selecionado: ðŸŒˆ Colorido AleatÃ³rio")
        
    elseif escolha == "3" then
        modoCorAtual = "CorSolida"
        print("\n" .. string.rep("-", 30))
        print("ESCOLHA A COR SÃ“LIDA:")
        print("1. ðŸ”´ Vermelho")
        print("2. ðŸŸ  Laranja") 
        print("3. ðŸŸ¡ Amarelo")
        print("4. ðŸŸ¢ Verde")
        print("5. ðŸ”µ Azul")
        print("6. ðŸŸ£ Roxo")
        print("7. ðŸŽ€ Rosa")
        print(string.rep("-", 30))
        
        write("Escolha a cor (1-7): ")
        local escolhaCor = read()
        
        local coresDisponiveis = {
            colors.red, colors.orange, colors.yellow,
            colors.green, colors.blue, colors.purple, colors.pink
        }
        
        if tonumber(escolhaCor) and tonumber(escolhaCor) >= 1 and tonumber(escolhaCor) <= 7 then
            corSolidaAtual = coresDisponiveis[tonumber(escolhaCor)]
            print("Cor sÃ³lida selecionada!")
        else
            corSolidaAtual = colors.red
            print("Cor padrÃ£o: ðŸ”´ Vermelho")
        end
        
    else
        print("Modo mantido: " .. modoCorAtual)
    end
    
    os.sleep(1)
end

-- MENU PRINCIPAL
function menuPrincipal()
    menuVelocidade()  -- Primeiro escolhe velocidade
    menuCores()       -- Depois escolhe cores
    
    print("\n" .. string.rep("=", 50))
    print("EFEITOS DISPONÃVEIS - " .. #telas .. " TELAS")
    print("ðŸŽµ Velocidade: " .. velocidadeAtual)
    print("ðŸŽ¨ Modo: " .. modoCorAtual)
    print(string.rep("=", 50))
    print("1. Pulso Sequencial")
    print("2. Onda")
    print("3. RespiraÃ§Ã£o")
    print("4. Barras Verticais")
    print("5. Pontos Sequenciais")
    print("6. Gradiente")
    print("7. Piscada AleatÃ³ria")
    print("8. Grupos Sequenciais")
    print("9. ðŸ”„ Trocar ConfiguraÃ§Ãµes")
    print("0. ðŸšª Sair")
    print(string.rep("=", 50))
    
    write("Escolha o efeito (1-9, 0=sair): ")
    local escolha = read()
    
    if escolha == "1" then pulsoSequencial()
    elseif escolha == "2" then onda()
    elseif escolha == "3" then respiracao()
    elseif escolha == "4" then barrasVerticais()
    elseif escolha == "5" then pontosSequenciais()
    elseif escolha == "6" then gradient()
    elseif escolha == "7" then piscadaAleatoria()
    elseif escolha == "8" then gruposSequenciais()
    elseif escolha == "9" then return true  -- Voltar para configuraÃ§Ãµes
    elseif escolha == "0" then 
        for i, tela in ipairs(telas) do
            tela.setBackgroundColor(colors.black)
            tela.clear()
        end
        return false
    else
        print("OpÃ§Ã£o invÃ¡lida!")
        os.sleep(1)
    end
    
    return true
end

-- PROGRAMA PRINCIPAL
function main()
    print("Sistema Profissional de IluminaÃ§Ã£o Iniciado!")
    
    local executando = true
    while executando do
        executando = menuPrincipal()
    end
    
    print("Programa encerrado!")
end

-- INICIAR
main()
