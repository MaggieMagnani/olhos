-- =============================================
-- SISTEMA COM EFEITO COMETAS + CORRE√á√ïES
-- =============================================

print("=== SISTEMA COM EFEITO COMETAS ===")

-- Pega TODAS as telas
local telas = {peripheral.find("monitor")}
if not telas[1] then telas = {telas} end

print("Telas detectadas: " .. #telas)

-- Configura todas as telas
for i, tela in ipairs(telas) do
    tela.setTextScale(0.5)
end

-- MODOS DE COR
local modosCor = {
    ["Branco"] = { cores = {colors.white} },
    ["ColoridoAleatorio"] = {
        cores = { colors.red, colors.orange, colors.yellow, colors.lime, 
                 colors.green, colors.cyan, colors.lightBlue, colors.blue, 
                 colors.purple, colors.pink, colors.magenta }
    },
    ["CorSolida"] = {
        cores = { colors.red, colors.orange, colors.yellow, colors.lime,
                 colors.green, colors.blue, colors.purple, colors.pink }
    }
}

-- VELOCIDADES
local velocidades = {
    ["Lenta"] = { multiplicador = 2.0 },
    ["Media"] = { multiplicador = 1.0 },
    ["Rapida"] = { multiplicador = 0.5 },
    ["Eletronica"] = { multiplicador = 0.25 }
}

-- Vari√°veis globais
local modoCorAtual = "Branco"
local velocidadeAtual = "Media"
local corSolidaAtual = colors.red

-- Fun√ß√£o para obter cor
function obterCor(telaIndex)
    if modoCorAtual == "Branco" then
        return colors.white
    elseif modoCorAtual == "ColoridoAleatorio" then
        return modosCor.ColoridoAleatorio.cores[math.random(1, #modosCor.ColoridoAleatorio.cores)]
    elseif modoCorAtual == "CorSolida" then
        return corSolidaAtual
    end
    return colors.white
end

-- Fun√ß√£o para aplicar velocidade
function aplicarVelocidade(tempoBase)
    return tempoBase * velocidades[velocidadeAtual].multiplicador
end

-- EFEITO 5: CONSTELA√á√ÉO EM MOVIMENTO (que voc√™ amou)
function constelacao()
    print("Constela√ß√£o em Movimento - Modo: " .. modoCorAtual .. " | Velocidade: " .. velocidadeAtual)
    
    local estrelas = {}
    local tempo = 0
    
    -- Cria estrelas iniciais
    for i, tela in ipairs(telas) do
        local w, h = tela.getSize()
        estrelas[i] = {}
        
        for s = 1, 8 do
            estrelas[i][s] = {
                x = math.random(2, w - 1),
                y = math.random(2, h - 1),
                velocidadeX = (math.random() - 0.5) * 0.8,
                velocidadeY = (math.random() - 0.5) * 0.8,
                tamanho = math.random(1, 3),
                brilho = math.random(1, 3),
                cor = obterCor(i)
            }
        end
    end
    
    while true do
        tempo = tempo + 1
        
        for i, tela in ipairs(telas) do
            local w, h = tela.getSize()
            tela.setBackgroundColor(colors.black)
            tela.clear()
            
            -- Atualiza e desenha estrelas
            for s, estrela in ipairs(estrelas[i]) do
                -- Move estrela
                estrela.x = estrela.x + estrela.velocidadeX
                estrela.y = estrela.y + estrela.velocidadeY
                
                -- Rebate nas bordas
                if estrela.x <= 1 or estrela.x >= w then
                    estrela.velocidadeX = -estrela.velocidadeX
                end
                if estrela.y <= 1 or estrela.y >= h then
                    estrela.velocidadeY = -estrela.velocidadeY
                end
                
                -- Mant√©m dentro dos limites
                estrela.x = math.max(1, math.min(w, estrela.x))
                estrela.y = math.max(1, math.min(h, estrela.y))
                
                -- Desenha estrela
                local cor = estrela.cor
                local x = math.floor(estrela.x)
                local y = math.floor(estrela.y)
                
                tela.setBackgroundColor(cor)
                tela.setCursorPos(x, y)
                tela.write(" ")
                
                -- Brilho para estrelas maiores
                if estrela.tamanho >= 2 then
                    if x > 1 then tela.setCursorPos(x - 1, y); tela.write(" ") end
                    if x < w then tela.setCursorPos(x + 1, y); tela.write(" ") end
                end
                if estrela.tamanho >= 3 then
                    if y > 1 then tela.setCursorPos(x, y - 1); tela.write(" ") end
                    if y < h then tela.setCursorPos(x, y + 1); tela.write(" ") end
                end
                
                -- Piscar aleat√≥rio
                if math.random(1, 50) == 1 then
                    estrela.brilho = math.random(1, 3)
                    estrela.cor = obterCor(i)
                end
            end
            
            -- Novas estrelas
            if tempo % 30 == 0 and #estrelas[i] < 12 then
                table.insert(estrelas[i], {
                    x = math.random(2, w - 1),
                    y = 1,
                    velocidadeX = (math.random() - 0.5) * 0.5,
                    velocidadeY = math.random(0.3, 0.8),
                    tamanho = math.random(1, 3),
                    brilho = math.random(1, 3),
                    cor = obterCor(i)
                })
            end
        end
        
        os.sleep(aplicarVelocidade(0.1))
    end
end

-- EFEITO 6B: COMETAS E RISCOS (CORRIGIDO E MELHORADO)
function cometas()
    print("Cometas e Riscos - Modo: " .. modoCorAtual .. " | Velocidade: " .. velocidadeAtual)
    
    local cometas = {}
    local tempo = 0
    
    for i, tela in ipairs(telas) do
        local w, h = tela.getSize()
        cometas[i] = {}
        
        -- Cria alguns cometas iniciais
        for c = 1, 3 do
            cometas[i][c] = {
                x = math.random(-10, w + 10),  -- Pode come√ßar fora da tela
                y = math.random(1, h),
                velocidadeX = math.random(-3, -1),  -- Sempre se move pra esquerda
                velocidadeY = (math.random() - 0.5) * 0.5,
                comprimento = math.random(5, 12),
                cor = obterCor(i),
                vida = math.random(50, 100)
            }
        end
    end
    
    while true do
        tempo = tempo + 1
        
        for i, tela in ipairs(telas) do
            local w, h = tela.getSize()
            tela.setBackgroundColor(colors.black)
            tela.clear()
            
            -- Atualiza e desenha cometas
            for c = #cometas[i], 1, -1 do
                local cometa = cometas[i][c]
                
                -- Move cometa
                cometa.x = cometa.x + cometa.velocidadeX
                cometa.y = cometa.y + cometa.velocidadeY
                cometa.vida = cometa.vida - 1
                
                -- Desenha risco/cometa
                for segmento = 0, cometa.comprimento do
                    local segX = math.floor(cometa.x + segmento)
                    local segY = math.floor(cometa.y + (segmento * 0.3))  -- Pequena curva
                    
                    -- Calcula intensidade (mais forte no in√≠cio do risco)
                    local intensidade = 1 - (segmento / cometa.comprimento)
                    
                    if segX >= 1 and segX <= w and segY >= 1 and segY <= h and intensidade > 0.2 then
                        tela.setBackgroundColor(cometa.cor)
                        tela.setCursorPos(segX, segY)
                        tela.write(" ")
                        
                        -- Faz o risco mais "grosso" no in√≠cio
                        if intensidade > 0.7 then
                            if segY > 1 then
                                tela.setCursorPos(segX, segY - 1)
                                tela.write(" ")
                            end
                            if segY < h then
                                tela.setCursorPos(segX, segY + 1)
                                tela.write(" ")
                            end
                        end
                    end
                end
                
                -- Remove cometa se saiu da tela ou sem vida
                if cometa.x < -cometa.comprimento or cometa.x > w + cometa.comprimento or cometa.vida <= 0 then
                    table.remove(cometas[i], c)
                end
            end
            
            -- Cria novos cometas ocasionalmente
            if math.random(1, 15) == 1 and #cometas[i] < 5 then
                table.insert(cometas[i], {
                    x = w + 5,  -- Come√ßa √† direita
                    y = math.random(1, h),
                    velocidadeX = math.random(-4, -2),  -- Move pra esquerda
                    velocidadeY = (math.random() - 0.5) * 0.3,
                    comprimento = math.random(8, 15),
                    cor = obterCor(i),
                    vida = math.random(80, 150)
                })
            end
        end
        
        os.sleep(aplicarVelocidade(0.08))
    end
end

-- EFEITO 7: LINHAS HORIZONTAIS FLUENTES
function linhasFluentes()
    print("Linhas Fluentes - Modo: " .. modoCorAtual .. " | Velocidade: " .. velocidadeAtual)
    
    local linhas = {}
    local tempo = 0
    
    for i, tela in ipairs(telas) do
        local w, h = tela.getSize()
        linhas[i] = {}
        
        -- Cria linhas iniciais
        for l = 1, 4 do
            linhas[i][l] = {
                y = math.random(1, h),
                velocidade = math.random(1, 3),
                direcao = math.random(0, 1) == 1 and 1 or -1,
                comprimento = math.random(3, 8),
                cor = obterCor(i),
                espessura = math.random(1, 2)
            }
        end
    end
    
    while true do
        tempo = tempo + 1
        
        for i, tela in ipairs(telas) do
            local w, h = tela.getSize()
            tela.setBackgroundColor(colors.black)
            tela.clear()
            
            -- Atualiza e desenha linhas
            for l, linha in ipairs(linhas[i]) do
                -- Move linha
                linha.y = linha.y + (linha.velocidade * linha.direcao * 0.1)
                
                -- Inverte dire√ß√£o se chegou nas bordas
                if linha.y <= 1 or linha.y >= h then
                    linha.direcao = -linha.direcao
                    linha.cor = obterCor(i)  -- Muda cor ao inverter
                end
                
                -- Mant√©m dentro dos limites
                linha.y = math.max(1, math.min(h, linha.y))
                
                -- Desenha linha horizontal
                local y = math.floor(linha.y)
                local cor = linha.cor
                
                for x = 1, w do
                    tela.setBackgroundColor(cor)
                    tela.setCursorPos(x, y)
                    tela.write(" ")
                    
                    -- Linhas mais espessas
                    if linha.espessura >= 2 then
                        if y > 1 then
                            tela.setCursorPos(x, y - 1)
                            tela.write(" ")
                        end
                        if y < h then
                            tela.setCursorPos(x, y + 1)
                            tela.write(" ")
                        end
                    end
                end
                
                -- Efeito de "onda" na linha
                if tempo % 20 == 0 then
                    linha.velocidade = math.random(1, 3)
                    linha.comprimento = math.random(3, 8)
                end
            end
            
            -- Novas linhas ocasionalmente
            if tempo % 40 == 0 and #linhas[i] < 6 then
                table.insert(linhas[i], {
                    y = math.random(1, h),
                    velocidade = math.random(1, 3),
                    direcao = math.random(0, 1) == 1 and 1 or -1,
                    comprimento = math.random(3, 8),
                    cor = obterCor(i),
                    espessura = math.random(1, 2)
                })
            end
        end
        
        os.sleep(aplicarVelocidade(0.1))
    end
end

-- [MANTENHA AQUI OS OUTROS EFEITOS ORIGINAIS...]

-- EFEITO 1: PULSO SEQUENCIAL
function pulsoSequencial()
    print("Pulso Sequencial - Modo: " .. modoCorAtual .. " | Velocidade: " .. velocidadeAtual)
    
    local telaAtiva = 1
    
    while true do
        for i, tela in ipairs(telas) do
            tela.setBackgroundColor(colors.black)
            tela.clear()
        end
        
        local cor = obterCor(telaAtiva)
        telas[telaAtiva].setBackgroundColor(cor)
        telas[telaAtiva].clear()
        
        telaAtiva = telaAtiva + 1
        if telaAtiva > #telas then telaAtiva = 1 end
        
        os.sleep(aplicarVelocidade(0.3))
    end
end

-- EFEITO 2: ONDA
function onda()
    print("Onda - Modo: " .. modoCorAtual .. " | Velocidade: " .. velocidadeAtual)
    
    local posicao = 0
    
    while true do
        posicao = posicao + 1
        
        for i, tela in ipairs(telas) do
            tela.setBackgroundColor(colors.black)
            tela.clear()
            
            local deveAcender = (posicao % #telas) + 1 == i
            
            if deveAcender then
                local cor = obterCor(i)
                tela.setBackgroundColor(cor)
                tela.clear()
            end
        end
        
        os.sleep(aplicarVelocidade(0.2))
    end
end

-- MENUS (simplificados)
function menuVelocidade()
    print("\nüéµ SELECIONE VELOCIDADE:")
    print("1. üê¢ Lenta | 2. üö∂ M√©dia | 3. üèÉ R√°pida | 4. ‚ö° Eletr√¥nica")
    write("Escolha (1-4): ")
    local e = read()
    if e == "1" then velocidadeAtual = "Lenta"
    elseif e == "2" then velocidadeAtual = "Media"
    elseif e == "3" then velocidadeAtual = "Rapida"
    elseif e == "4" then velocidadeAtual = "Eletronica" end
    os.sleep(1)
end

function menuCores()
    print("\nüé® SELECIONE CORES:")
    print("1. ‚ö™ Branco | 2. üåà Colorido | 3. üé® Cor S√≥lida")
    write("Escolha (1-3): ")
    local e = read()
    if e == "1" then modoCorAtual = "Branco"
    elseif e == "2" then modoCorAtual = "ColoridoAleatorio"
    elseif e == "3" then 
        modoCorAtual = "CorSolida"
        print("üé® Cores: 1.üî¥ 2.üü† 3.üü° 4.üü¢ 5.üîµ 6.üü£ 7.üéÄ")
        write("Escolha (1-7): ")
        local c = tonumber(read())
        local cores = {colors.red, colors.orange, colors.yellow, colors.green, colors.blue, colors.purple, colors.pink}
        if c and c >=1 and c <=7 then corSolidaAtual = cores[c] end
    end
    os.sleep(1)
end

-- MENU PRINCIPAL ATUALIZADO
function menuPrincipal()
    menuVelocidade()
    menuCores()
    
    print("\n" .. string.rep("=", 50))
    print("EFEITOS - " .. #telas .. " TELAS")
    print("Velocidade: " .. velocidadeAtual .. " | Modo: " .. modoCorAtual)
    print(string.rep("=", 50))
    print("1. Pulso Sequencial")
    print("2. Onda")
    print("3. Respira√ß√£o")
    print("4. Barras Verticais")
    print("5. üåü Constela√ß√£o (QUE VOC√ä AMOU)")
    print("6. üöÄ Cometas e Riscos (NOVO)")
    print("7. ‚ûñ Linhas Fluentes (NOVO)")
    print("8. Piscada Aleat√≥ria")
    print("9. üîÑ Trocar Config")
    print("0. üö™ Sair")
    print(string.rep("=", 50))
    
    write("Escolha (1-9, 0=sair): ")
    local e = read()
    
    if e == "1" then pulsoSequencial()
    elseif e == "2" then onda()
    elseif e == "5" then constelacao()
    elseif e == "6" then cometas()
    elseif e == "7" then linhasFluentes()
    elseif e == "9" then return true
    elseif e == "0" then 
        for i, tela in ipairs(telas) do
            tela.setBackgroundColor(colors.black)
            tela.clear()
        end
        return false
    else
        print("Op√ß√£o inv√°lida!")
        os.sleep(1)
    end
    
    return true
end

-- PROGRAMA PRINCIPAL
function main()
    print("Sistema Cometas Iniciado!")
    
    local executando = true
    while executando do
        executando = menuPrincipal()
    end
    
    print("Programa encerrado!")
end

-- INICIAR
main()
