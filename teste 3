-- =============================================
-- SISTEMA COMPLETO DE EFEITOS VISUAIS - BALADA
-- =============================================

print("=== SISTEMA DE EFEITOS VISUAIS ===")

-- Pega TODAS as telas
local telas = {peripheral.find("monitor")}
if not telas[1] then telas = {telas} end

print("Telas detectadas: " .. #telas)

-- Configura todas as telas
for i, tela in ipairs(telas) do
    tela.setTextScale(0.5)
end

-- MODOS DE COR
local modosCor = {
    ["Branco"] = { cores = {colors.white} },
    ["ColoridoAleatorio"] = {
        cores = { colors.red, colors.orange, colors.yellow, colors.lime, 
                 colors.green, colors.cyan, colors.lightBlue, colors.blue, 
                 colors.purple, colors.pink, colors.magenta }
    },
    ["CorSolida"] = {
        cores = { colors.red, colors.orange, colors.yellow, colors.lime,
                 colors.green, colors.blue, colors.purple, colors.pink }
    }
}

-- VELOCIDADES
local velocidades = {
    ["Lenta"] = { multiplicador = 2.5 },
    ["Media"] = { multiplicador = 1.5 },
    ["Rapida"] = { multiplicador = 1.0 },
    ["Eletronica"] = { multiplicador = 0.4 },
    ["Ultra"] = { multiplicador = 0.15 }
}

-- Variaveis globais
local modoCorAtual = "Branco"
local velocidadeAtual = "Media"
local corSolidaAtual = colors.red
local executandoEfeito = true

-- Funcao para obter cor
function obterCor(telaIndex)
    if modoCorAtual == "Branco" then
        return colors.white
    elseif modoCorAtual == "ColoridoAleatorio" then
        return modosCor.ColoridoAleatorio.cores[math.random(1, #modosCor.ColoridoAleatorio.cores)]
    elseif modoCorAtual == "CorSolida" then
        return corSolidaAtual
    end
    return colors.white
end

-- Funcao para aplicar velocidade
function aplicarVelocidade(tempoBase)
    return tempoBase * velocidades[velocidadeAtual].multiplicador
end

-- EFEITO 1: PULSO SEQUENCIAL
function pulsoSequencial()
    print("Pulso Sequencial - Modo: " .. modoCorAtual .. " | Velocidade: " .. velocidadeAtual)
    print("Pressione CTRL+T para parar")
    
    local telaAtiva = 1
    executandoEfeito = true
    
    while executandoEfeito do
        for i, tela in ipairs(telas) do
            tela.setBackgroundColor(colors.black)
            tela.clear()
        end
        
        local cor = obterCor(telaAtiva)
        telas[telaAtiva].setBackgroundColor(cor)
        telas[telaAtiva].clear()
        
        telaAtiva = telaAtiva + 1
        if telaAtiva > #telas then telaAtiva = 1 end
        
        os.sleep(aplicarVelocidade(0.3))
    end
    
    -- Limpar ao sair
    for i, tela in ipairs(telas) do
        tela.setBackgroundColor(colors.black)
        tela.clear()
    end
end

-- EFEITO 2: ONDA
function onda()
    print("Onda - Modo: " .. modoCorAtual .. " | Velocidade: " .. velocidadeAtual)
    print("Pressione CTRL+T para parar")
    
    local posicao = 0
    executandoEfeito = true
    
    while executandoEfeito do
        posicao = posicao + 1
        
        for i, tela in ipairs(telas) do
            tela.setBackgroundColor(colors.black)
            tela.clear()
            
            local deveAcender = (posicao % #telas) + 1 == i
            
            if deveAcender then
                local cor = obterCor(i)
                tela.setBackgroundColor(cor)
                tela.clear()
            end
        end
        
        os.sleep(aplicarVelocidade(0.2))
    end
    
    -- Limpar ao sair
    for i, tela in ipairs(telas) do
        tela.setBackgroundColor(colors.black)
        tela.clear()
    end
end

-- EFEITO 3: EXPLOSOES DE ENERGIA
function explosoes()
    print("Explosoes de Energia - Modo: " .. modoCorAtual .. " | Velocidade: " .. velocidadeAtual)
    print("Pressione CTRL+T para parar")
    
    local explosoes = {}
    local tempo = 0
    executandoEfeito = true
    
    for i, tela in ipairs(telas) do
        local w, h = tela.getSize()
        explosoes[i] = {}
    end
    
    while executandoEfeito do
        tempo = tempo + 1
        
        for i, tela in ipairs(telas) do
            local w, h = tela.getSize()
            tela.setBackgroundColor(colors.black)
            tela.clear()
            
            for e = #explosoes[i], 1, -1 do
                local explosao = explosoes[i][e]
                
                explosao.raio = explosao.raio + explosao.velocidade
                explosao.vida = explosao.vida - 1
                
                local centroX, centroY = explosao.x, explosao.y
                local cor = explosao.cor
                
                for angulo = 0, 360, 15 do
                    local x = centroX + math.cos(math.rad(angulo)) * explosao.raio
                    local y = centroY + math.sin(math.rad(angulo)) * explosao.raio
                    
                    x, y = math.floor(x), math.floor(y)
                    
                    if x >= 1 and x <= w and y >= 1 and y <= h then
                        tela.setBackgroundColor(cor)
                        tela.setCursorPos(x, y)
                        tela.write(" ")
                    end
                end
                
                if explosao.vida <= 0 or explosao.raio > math.max(w, h) then
                    table.remove(explosoes[i], e)
                end
            end
            
            if math.random(1, 20) == 1 then
                local w, h = tela.getSize()
                table.insert(explosoes[i], {
                    x = math.random(5, w - 5),
                    y = math.random(5, h - 5),
                    raio = 1,
                    velocidade = math.random(1, 3) * 0.5,
                    vida = math.random(30, 60),
                    cor = obterCor(i)
                })
            end
        end
        
        os.sleep(aplicarVelocidade(0.08))
    end
    
    -- Limpar ao sair
    for i, tela in ipairs(telas) do
        tela.setBackgroundColor(colors.black)
        tela.clear()
    end
end

-- EFEITO 4: BARRAS VERTICAIS
function barrasVerticais()
    print("Barras Verticais - Modo: " .. modoCorAtual .. " | Velocidade: " .. velocidadeAtual)
    print("Pressione CTRL+T para parar")
    
    local offset = 0
    executandoEfeito = true
    
    while executandoEfeito do
        offset = offset + 1
        
        for i, tela in ipairs(telas) do
            local w, h = tela.getSize()
            tela.setBackgroundColor(colors.black)
            tela.clear()
            
            for barra = 1, 2 do
                local x = (offset + barra * 4 + i * 2) % w + 1
                local cor = obterCor(i)
                
                for y = 1, h do
                    tela.setBackgroundColor(cor)
                    tela.setCursorPos(x, y)
                    tela.write(" ")
                end
            end
        end
        
        os.sleep(aplicarVelocidade(0.15))
    end
    
    -- Limpar ao sair
    for i, tela in ipairs(telas) do
        tela.setBackgroundColor(colors.black)
        tela.clear()
    end
end

-- EFEITO 5: CONSTELACAO EM MOVIMENTO
function constelacao()
    print("Constelacao em Movimento - Modo: " .. modoCorAtual .. " | Velocidade: " .. velocidadeAtual)
    print("Pressione CTRL+T para parar")
    
    local estrelas = {}
    local tempo = 0
    executandoEfeito = true
    
    for i, tela in ipairs(telas) do
        local w, h = tela.getSize()
        estrelas[i] = {}
        
        for s = 1, 8 do
            estrelas[i][s] = {
                x = math.random(2, w - 1),
                y = math.random(2, h - 1),
                velocidadeX = (math.random() - 0.5) * 0.8,
                velocidadeY = (math.random() - 0.5) * 0.8,
                tamanho = math.random(1, 3),
                cor = obterCor(i)
            }
        end
    end
    
    while executandoEfeito do
        tempo = tempo + 1
        
        for i, tela in ipairs(telas) do
            local w, h = tela.getSize()
            tela.setBackgroundColor(colors.black)
            tela.clear()
            
            for s, estrela in ipairs(estrelas[i]) do
                estrela.x = estrela.x + estrela.velocidadeX
                estrela.y = estrela.y + estrela.velocidadeY
                
                if estrela.x <= 1 or estrela.x >= w then
                    estrela.velocidadeX = -estrela.velocidadeX
                end
                if estrela.y <= 1 or estrela.y >= h then
                    estrela.velocidadeY = -estrela.velocidadeY
                end
                
                estrela.x = math.max(1, math.min(w, estrela.x))
                estrela.y = math.max(1, math.min(h, estrela.y))
                
                local cor = estrela.cor
                local x = math.floor(estrela.x)
                local y = math.floor(estrela.y)
                
                tela.setBackgroundColor(cor)
                tela.setCursorPos(x, y)
                tela.write(" ")
                
                if estrela.tamanho >= 2 then
                    if x > 1 then tela.setCursorPos(x - 1, y); tela.write(" ") end
                    if x < w then tela.setCursorPos(x + 1, y); tela.write(" ") end
                end
                if estrela.tamanho >= 3 then
                    if y > 1 then tela.setCursorPos(x, y - 1); tela.write(" ") end
                    if y < h then tela.setCursorPos(x, y + 1); tela.write(" ") end
                end
                
                if math.random(1, 50) == 1 then
                    estrela.cor = obterCor(i)
                end
            end
            
            if tempo % 30 == 0 and #estrelas[i] < 12 then
                table.insert(estrelas[i], {
                    x = math.random(2, w - 1),
                    y = 1,
                    velocidadeX = (math.random() - 0.5) * 0.5,
                    velocidadeY = math.random(0.3, 0.8),
                    tamanho = math.random(1, 3),
                    cor = obterCor(i)
                })
            end
        end
        
        os.sleep(aplicarVelocidade(0.1))
    end
    
    -- Limpar ao sair
    for i, tela in ipairs(telas) do
        tela.setBackgroundColor(colors.black)
        tela.clear()
    end
end

-- EFEITO 6: BOLINHAS PASSANDO
function bolinhas()
    print("Bolinhas Passando - Modo: " .. modoCorAtual .. " | Velocidade: " .. velocidadeAtual)
    print("Pressione CTRL+T para parar")
    
    local bolinhas = {}
    local tempo = 0
    executandoEfeito = true
    
    for i, tela in ipairs(telas) do
        local w, h = tela.getSize()
        bolinhas[i] = {}
        
        for b = 1, 4 do
            bolinhas[i][b] = {
                x = math.random(-5, w + 5),
                y = math.random(1, h),
                velocidadeX = math.random(2, 4),
                velocidadeY = (math.random() - 0.5) * 0.5,
                tamanho = math.random(1, 2),
                cor = obterCor(i),
                vida = math.random(50, 100)
            }
        end
    end
    
    while executandoEfeito do
        tempo = tempo + 1
        
        for i, tela in ipairs(telas) do
            local w, h = tela.getSize()
            tela.setBackgroundColor(colors.black)
            tela.clear()
            
            for b = #bolinhas[i], 1, -1 do
                local bolinha = bolinhas[i][b]
                
                bolinha.x = bolinha.x - bolinha.velocidadeX * 0.3
                bolinha.y = bolinha.y + bolinha.velocidadeY
                bolinha.vida = bolinha.vida - 1
                
                local x = math.floor(bolinha.x)
                local y = math.floor(bolinha.y)
                
                if x >= 1 and x <= w and y >= 1 and y <= h then
                    tela.setBackgroundColor(bolinha.cor)
                    tela.setCursorPos(x, y)
                    tela.write(" ")
                    
                    if bolinha.tamanho >= 2 then
                        if x > 1 then tela.setCursorPos(x - 1, y); tela.write(" ") end
                        if x < w then tela.setCursorPos(x + 1, y); tela.write(" ") end
                        if y > 1 then tela.setCursorPos(x, y - 1); tela.write(" ") end
                        if y < h then tela.setCursorPos(x, y + 1); tela.write(" ") end
                    end
                end
                
                if bolinha.x < -5 or bolinha.x > w + 5 or bolinha.y < -5 or bolinha.y > h + 5 or bolinha.vida <= 0 then
                    table.remove(bolinhas[i], b)
                end
            end
            
            if math.random(1, 10) == 1 and #bolinhas[i] < 6 then
                table.insert(bolinhas[i], {
                    x = w + 5,
                    y = math.random(1, h),
                    velocidadeX = math.random(2, 5),
                    velocidadeY = (math.random() - 0.5) * 0.3,
                    tamanho = math.random(1, 2),
                    cor = obterCor(i),
                    vida = math.random(80, 150)
                })
            end
        end
        
        os.sleep(aplicarVelocidade(0.1))
    end
    
    -- Limpar ao sair
    for i, tela in ipairs(telas) do
        tela.setBackgroundColor(colors.black)
        tela.clear()
    end
end

-- EFEITO 7: PISCADA ALEATORIA
function piscadaAleatoria()
    print("Piscada Aleatoria - Modo: " .. modoCorAtual .. " | Velocidade: " .. velocidadeAtual)
    print("Pressione CTRL+T para parar")
    
    executandoEfeito = true
    
    while executandoEfeito do
        for i, tela in ipairs(telas) do
            tela.setBackgroundColor(colors.black)
            tela.clear()
        end
        
        local maxTelas = math.max(1, #telas - 1)
        local telasParaAcender = math.random(1, maxTelas)
        
        for a = 1, telasParaAcender do
            local telaAleatoria = math.random(1, #telas)
            local cor = obterCor(telaAleatoria)
            telas[telaAleatoria].setBackgroundColor(cor)
            telas[telaAleatoria].clear()
        end
        
        os.sleep(aplicarVelocidade(0.4))
        
        for i, tela in ipairs(telas) do
            tela.setBackgroundColor(colors.black)
            tela.clear()
        end
        
        os.sleep(aplicarVelocidade(0.3))
    end
    
    -- Limpar ao sair
    for i, tela in ipairs(telas) do
        tela.setBackgroundColor(colors.black)
        tela.clear()
    end
end

-- EFEITO 8: GRUPOS SEQUENCIAIS
function gruposSequenciais()
    print("Grupos Sequenciais - Modo: " .. modoCorAtual .. " | Velocidade: " .. velocidadeAtual)
    print("Pressione CTRL+T para parar")
    
    local grupoAtual = 1
    local telasPorGrupo = math.max(1, math.floor(#telas / 3))
    executandoEfeito = true
    
    while executandoEfeito do
        for i, tela in ipairs(telas) do
            tela.setBackgroundColor(colors.black)
            tela.clear()
        end
        
        local inicio = (grupoAtual - 1) * telasPorGrupo + 1
        local fim = math.min(grupoAtual * telasPorGrupo, #telas)
        
        for i = inicio, fim do
            if telas[i] then
                local cor = obterCor(i)
                telas[i].setBackgroundColor(cor)
                telas[i].clear()
            end
        end
        
        grupoAtual = grupoAtual + 1
        if grupoAtual > math.ceil(#telas / telasPorGrupo) then
            grupoAtual = 1
        end
        
        os.sleep(aplicarVelocidade(0.5))
    end
    
    -- Limpar ao sair
    for i, tela in ipairs(telas) do
        tela.setBackgroundColor(colors.black)
        tela.clear()
    end
end

-- EFEITO 9 NOVO: PULSO COR SOLIDA
function pulsoCorSolida()
    print("Pulso Cor Sólida - Todas as telas na mesma cor!")
    print("Pressione CTRL+T para parar")
    
    local coresSequencia = {
        colors.red, colors.orange, colors.yellow, colors.green,
        colors.blue, colors.purple, colors.pink, colors.white,
        colors.cyan, colors.magenta, colors.lime, colors.lightBlue
    }
    
    local corIndex = 1
    executandoEfeito = true
    
    while executandoEfeito do
        -- PEGAR COR ATUAL
        local corAtual = coresSequencia[corIndex]
        
        -- FASE 1: ASCENDER TODAS AS TELAS
        for i, tela in ipairs(telas) do
            tela.setBackgroundColor(corAtual)
            tela.clear()
        end
        os.sleep(aplicarVelocidade(0.4))
        
        -- FASE 2: APAGAR TODAS AS TELAS
        for i, tela in ipairs(telas) do
            tela.setBackgroundColor(colors.black)
            tela.clear()
        end
        os.sleep(aplicarVelocidade(0.2))
        
        -- PRÓXIMA COR
        corIndex = corIndex + 1
        if corIndex > #coresSequencia then
            corIndex = 1
        end
    end
    
    -- Limpar ao sair
    for i, tela in ipairs(telas) do
        tela.setBackgroundColor(colors.black)
        tela.clear()
    end
end

-- EFEITO 10 NOVO: CHAMAS DANÇANTES
function chamasDancantes()
    print("Chamas Dançantes - Fogo animado em todas as telas!")
    print("Pressione CTRL+T para parar")
    
    local tempo = 0
    executandoEfeito = true
    
    -- CORES DO FOGO (vermelho, laranja, amarelo)
    local coresFogo = {colors.red, colors.orange, colors.yellow}
    
    while executandoEfeito do
        tempo = tempo + 1
        
        for i, tela in ipairs(telas) do
            local w, h = tela.getSize()
            
            -- LIMPAR TELA
            tela.setBackgroundColor(colors.black)
            tela.clear()
            
            -- GERAR CHAMAS
            for x = 1, w do
                -- ALTURA DA CHAMA (base + variação)
                local alturaBase = math.floor(h * 0.6)
                local variacao = math.sin(x * 0.3 + tempo * 0.2) * 2
                local alturaChama = alturaBase + variacao
                
                -- DESENHAR CHAMA
                for y = 1, alturaChama do
                    if y >= 1 and y <= h then
                        -- COR BASEADA NA ALTURA
                        local corIndex
                        if y < alturaChama * 0.3 then
                            corIndex = 3 -- AMARELO (topo)
                        elseif y < alturaChama * 0.6 then
                            corIndex = 2 -- LARANJA (meio)
                        else
                            corIndex = 1 -- VERMELHO (base)
                        end
                        
                        -- EFEITO DE PISCAR
                        if math.random(1, 10) > 2 then
                            tela.setBackgroundColor(coresFogo[corIndex])
                            tela.setCursorPos(x, h - y + 1)
                            tela.write(" ")
                        end
                    end
                end
                
                -- FAÍSCAS
                if math.random(1, 20) == 1 then
                    local faiscaX = x
                    local faiscaY = math.random(math.floor(alturaChama * 1.1), h)
                    if faiscaY >= 1 and faiscaY <= h then
                        tela.setBackgroundColor(colors.yellow)
                        tela.setCursorPos(faiscaX, h - faiscaY + 1)
                        tela.write(" ")
                    end
                end
            end
        end
        
        os.sleep(aplicarVelocidade(0.1))
    end
    
    -- Limpar ao sair
    for i, tela in ipairs(telas) do
        tela.setBackgroundColor(colors.black)
        tela.clear()
    end
end

-- EFEITO 11 NOVO: AGUA FLUINDO
function aguaFluindo()
    print("Água Fluindo - Efeito líquido relaxante!")
    print("Pressione CTRL+T para parar")
    
    local tempo = 0
    executandoEfeito = true
    
    -- CORES DA ÁGUA
    local coresAgua = {colors.blue, colors.cyan, colors.lightBlue}
    
    while executandoEfeito do
        tempo = tempo + 1
        
        for i, tela in ipairs(telas) do
            local w, h = tela.getSize()
            
            -- LIMPAR TELA
            tela.setBackgroundColor(colors.black)
            tela.clear()
            
            -- GERAR ONDAS
            for y = 1, h do
                local alturaOnda = (math.sin(y * 0.2 + tempo * 0.1) + 1) * 0.5
                local nivelAgua = math.floor(alturaOnda * h * 0.8)
                
                for x = 1, w do
                    -- MOVIMENTO DE ONDA
                    local offsetX = math.sin(x * 0.1 + tempo * 0.05) * 2
                    local posX = x + offsetX
                    
                    if posX >= 1 and posX <= w and y <= nivelAgua then
                        -- COR BASEADA NA PROFUNDIDADE
                        local corIndex = math.floor((y / nivelAgua) * #coresAgua) + 1
                        corIndex = math.min(corIndex, #coresAgua)
                        
                        tela.setBackgroundColor(coresAgua[corIndex])
                        tela.setCursorPos(math.floor(posX), y)
                        tela.write(" ")
                    end
                end
            end
            
            -- BOLHAS SUBINDO
            if tempo % 5 == 0 then
                for bolha = 1, 3 do
                    local bolhaX = math.random(2, w-1)
                    local bolhaY = math.random(1, h-1)
                    
                    tela.setBackgroundColor(colors.white)
                    tela.setCursorPos(bolhaX, bolhaY)
                    tela.write(" ")
                end
            end
        end
        
        os.sleep(aplicarVelocidade(0.15))
    end
    
    -- Limpar ao sair
    for i, tela in ipairs(telas) do
        tela.setBackgroundColor(colors.black)
        tela.clear()
    end
end

-- EFEITO 12 NOVO: PARTICULAS VOANDO
function particulasVoando()
    print("Partículas Voando - Partículas coloridas se movendo!")
    print("Pressione CTRL+T para parar")
    
    local particulas = {}
    local tempo = 0
    executandoEfeito = true
    
    -- INICIALIZAR PARTICULAS
    for i, tela in ipairs(telas) do
        local w, h = tela.getSize()
        particulas[i] = {}
        
        for p = 1, 15 do
            particulas[i][p] = {
                x = math.random(1, w),
                y = math.random(1, h),
                velocidadeX = (math.random() - 0.5) * 1.5,
                velocidadeY = (math.random() - 0.5) * 1.5,
                cor = modosCor.ColoridoAleatorio.cores[math.random(1, #modosCor.ColoridoAleatorio.cores)],
                tamanho = math.random(1, 2),
                vida = math.random(50, 200)
            }
        end
    end
    
    while executandoEfeito do
        tempo = tempo + 1
        
        for i, tela in ipairs(telas) do
            local w, h = tela.getSize()
            
            -- LIMPAR TELA
            tela.setBackgroundColor(colors.black)
            tela.clear()
            
            -- ATUALIZAR PARTICULAS
            for p = #particulas[i], 1, -1 do
                local particula = particulas[i][p]
                
                -- MOVER PARTICULA
                particula.x = particula.x + particula.velocidadeX
                particula.y = particula.y + particula.velocidadeY
                particula.vida = particula.vida - 1
                
                -- VERIFICAR BORDAS
                if particula.x < 1 then particula.x = 1; particula.velocidadeX = -particula.velocidadeX end
                if particula.x > w then particula.x = w; particula.velocidadeX = -particula.velocidadeX end
                if particula.y < 1 then particula.y = 1; particula.velocidadeY = -particula.velocidadeY end
                if particula.y > h then particula.y = h; particula.velocidadeY = -particula.velocidadeY end
                
                -- DESENHAR PARTICULA
                local x = math.floor(particula.x)
                local y = math.floor(particula.y)
                
                if x >= 1 and x <= w and y >= 1 and y <= h then
                    tela.setBackgroundColor(particula.cor)
                    tela.setCursorPos(x, y)
                    tela.write(" ")
                    
                    -- PARTICULA GRANDE
                    if particula.tamanho >= 2 then
                        if x > 1 then tela.setCursorPos(x-1, y); tela.write(" ") end
                        if x < w then tela.setCursorPos(x+1, y); tela.write(" ") end
                        if y > 1 then tela.setCursorPos(x, y-1); tela.write(" ") end
                        if y < h then tela.setCursorPos(x, y+1); tela.write(" ") end
                    end
                end
                
                -- REMOVER PARTICULAS VELHAS
                if particula.vida <= 0 then
                    table.remove(particulas[i], p)
                end
            end
            
            -- ADICIONAR NOVAS PARTICULAS
            if #particulas[i] < 20 and math.random(1, 5) == 1 then
                table.insert(particulas[i], {
                    x = math.random(1, w),
                    y = math.random(1, h),
                    velocidadeX = (math.random() - 0.5) * 2,
                    velocidadeY = (math.random() - 0.5) * 2,
                    cor = modosCor.ColoridoAleatorio.cores[math.random(1, #modosCor.ColoridoAleatorio.cores)],
                    tamanho = math.random(1, 2),
                    vida = math.random(80, 150)
                })
            end
        end
        
        os.sleep(aplicarVelocidade(0.08))
    end
    
    -- Limpar ao sair
    for i, tela in ipairs(telas) do
        tela.setBackgroundColor(colors.black)
        tela.clear()
    end
end

-- EFEITO 13 NOVO: TUNEL 3D
function tunel3D()
    print("Túnel 3D - Efeito de profundidade infinito!")
    print("Pressione CTRL+T para parar")
    
    local tempo = 0
    executandoEfeito = true
    
    while executandoEfeito do
        tempo = tempo + 1
        
        for i, tela in ipairs(telas) do
            local w, h = tela.getSize()
            local centroX, centroY = w/2, h/2
            
            -- LIMPAR TELA
            tela.setBackgroundColor(colors.black)
            tela.clear()
            
            -- DESENHAR TÚNEL
            for x = 1, w do
                for y = 1, h do
                    -- CALCULAR DISTÂNCIA E ÂNGULO DO CENTRO
                    local dx, dy = x - centroX, y - centroY
                    local distancia = math.sqrt(dx*dx + dy*dy)
                    local angulo = math.atan2(dy, dx)
                    
                    -- EFEITO DE TÚNEL (espiral)
                    local raio = distancia / math.max(w, h) * 10
                    local fase = (angulo + tempo * 0.05) / (2 * math.pi)
                    
                    -- PADRÃO DO TÚNEL
                    local valor = (math.sin(raio - fase * 10) + 1) / 2
                    
                    if valor > 0.4 then
                        -- COR BASEADA NA POSIÇÃO NO TÚNEL
                        local corIndex = math.floor((fase + raio * 0.1) * 8) % #modosCor.ColoridoAleatorio.cores + 1
                        local cor = modosCor.ColoridoAleatorio.cores[corIndex]
                        
                        tela.setBackgroundColor(cor)
                        tela.setCursorPos(x, y)
                        tela.write(" ")
                    end
                end
            end
        end
        
        os.sleep(aplicarVelocidade(0.12))
    end
    
    -- Limpar ao sair
    for i, tela in ipairs(telas) do
        tela.setBackgroundColor(colors.black)
        tela.clear()
    end
end

-- EFEITO 14: STROBE TODAS AS TELAS
function strobeTodasTelas()
    print("STROBE - Todas as telas piscando juntas!")
    print("Pressione CTRL+T para parar")
    
    local strobeCount = 0
    local maxStrobes = 100  -- Limite de segurança
    executandoEfeito = true
    
    while executandoEfeito and strobeCount < maxStrobes do
        strobeCount = strobeCount + 1
        
        -- FASE 1: TODAS AS TELAS LIGADAS
        for i, tela in ipairs(telas) do
            local cor = obterCor(i)
            tela.setBackgroundColor(cor)
            tela.clear()
        end
        os.sleep(aplicarVelocidade(0.08))  -- Muito rápido!
        
        -- FASE 2: TODAS AS TELAS DESLIGADAS
        for i, tela in ipairs(telas) do
            tela.setBackgroundColor(colors.black)
            tela.clear()
        end
        os.sleep(aplicarVelocidade(0.08))  -- Muito rápido!
        
        -- Efeito especial a cada 10 strobes
        if strobeCount % 10 == 0 then
            -- Piscar com cores diferentes
            for i, tela in ipairs(telas) do
                tela.setBackgroundColor(colors.white)
                tela.clear()
            end
            os.sleep(aplicarVelocidade(0.04))
            
            for i, tela in ipairs(telas) do
                tela.setBackgroundColor(colors.black)
                tela.clear()
            end
            os.sleep(aplicarVelocidade(0.04))
        end
    end
    
    -- Limpar ao sair
    for i, tela in ipairs(telas) do
        tela.setBackgroundColor(colors.black)
        tela.clear()
    end
    
    if strobeCount >= maxStrobes then
        print("Strobe automaticamente parado após " .. maxStrobes .. " ciclos")
    end
end

-- MENU VELOCIDADE
function menuVelocidade()
    print("\n" .. string.rep("=", 40))
    print("SELECIONE A VELOCIDADE")
    print(string.rep("=", 40))
    print("1. Lenta")
    print("2. Media")
    print("3. Rapida")
    print("4. Eletronica")
    print("5. Ultra")
    print(string.rep("=", 40))
    
    write("Escolha (1-5): ")
    local escolha = read()
    
    if escolha == "1" then velocidadeAtual = "Lenta"
    elseif escolha == "2" then velocidadeAtual = "Media"
    elseif escolha == "3" then velocidadeAtual = "Rapida"
    elseif escolha == "4" then velocidadeAtual = "Eletronica"
    elseif escolha == "5" then velocidadeAtual = "Ultra"
    else print("Velocidade mantida: " .. velocidadeAtual) end
    
    os.sleep(1)
end

-- MENU CORES
function menuCores()
    print("\n" .. string.rep("=", 35))
    print("SELECIONE CORES")
    print(string.rep("=", 35))
    print("1. Branco e Preto")
    print("2. Colorido Aleatorio")
    print("3. Cor Solida")
    print(string.rep("=", 35))
    
    write("Escolha (1-3): ")
    local escolha = read()
    
    if escolha == "1" then
        modoCorAtual = "Branco"
        print("Modo: Branco e Preto")
    elseif escolha == "2" then
        modoCorAtual = "ColoridoAleatorio"
        print("Modo: Colorido Aleatorio")
    elseif escolha == "3" then
        modoCorAtual = "CorSolida"
        print("\nESCOLHA A COR:")
        print("1. Vermelho")
        print("2. Laranja")
        print("3. Amarelo")
        print("4. Verde")
        print("5. Azul")
        print("6. Roxo")
        print("7. Rosa")
        write("Cor (1-7): ")
        local corEscolha = tonumber(read())
        local cores = {colors.red, colors.orange, colors.yellow, colors.green, colors.blue, colors.purple, colors.pink}
        if corEscolha and corEscolha >=1 and corEscolha <=7 then
            corSolidaAtual = cores[corEscolha]
            print("Cor solida selecionada")
        end
    else
        print("Modo mantido: " .. modoCorAtual)
    end
    
    os.sleep(1)
end

-- MENU PRINCIPAL
function menuPrincipal()
    menuVelocidade()
    menuCores()
    
    print("\n" .. string.rep("=", 50))
    print("EFEITOS DISPONIVEIS - " .. #telas .. " TELAS")
    print("Velocidade: " .. velocidadeAtual)
    print("Modo: " .. modoCorAtual)
    print(string.rep("=", 50))
    print("1. Pulso Sequencial")
    print("2. Onda")
    print("3. Explosoes de Energia")
    print("4. Barras Verticais")
    print("5. Constelacao em Movimento")
    print("6. Bolinhas Passando")
    print("7. Piscada Aleatoria")
    print("8. Grupos Sequenciais")
    print("9. Pulso Cor Solida (NOVO!)")
    print("10. Chamas Dançantes (NOVO!)")
    print("11. Agua Fluindo (NOVO!)")
    print("12. Partículas Voando (NOVO!)")
    print("13. Túnel 3D (NOVO!)")
    print("14. Strobe Todas as Telas")
    print("15. Trocar Configuracoes")
    print("0. Sair")
    print(string.rep("=", 50))
    
    write("Escolha o efeito (1-15, 0=sair): ")
    local escolha = read()
    
    executandoEfeito = true
    
    if escolha == "1" then pulsoSequencial()
    elseif escolha == "2" then onda()
    elseif escolha == "3" then explosoes()
    elseif escolha == "4" then barrasVerticais()
    elseif escolha == "5" then constelacao()
    elseif escolha == "6" then bolinhas()
    elseif escolha == "7" then piscadaAleatoria()
    elseif escolha == "8" then gruposSequenciais()
    elseif escolha == "9" then pulsoCorSolida()
    elseif escolha == "10" then chamasDancantes()
    elseif escolha == "11" then aguaFluindo()
    elseif escolha == "12" then particulasVoando()
    elseif escolha == "13" then tunel3D()
    elseif escolha == "14" then strobeTodasTelas()
    elseif escolha == "15" then return true
    elseif escolha == "0" then 
        for i, tela in ipairs(telas) do
            tela.setBackgroundColor(colors.black)
            tela.clear()
        end
        return false
    else
        print("Opcao invalida!")
        os.sleep(1)
    end
    
    return true
end

-- PROGRAMA PRINCIPAL
function main()
    print("Sistema Completo Iniciado!")
    print("Controles: CTRL+T para parar qualquer efeito")
    
    local executando = true
    while executando do
        executando = menuPrincipal()
    end
    
    print("Programa encerrado!")
end

-- INICIAR
main()
