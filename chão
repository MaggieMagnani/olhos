-- =============================================
-- DJ CONTROLLER - SISTEMA CONT√çNUO
-- =============================================

print("=== DJ CONTROLLER INICIADO ===")

-- Pega TODAS as telas
local telas = {peripheral.find("monitor")}
if not telas[1] then telas = {telas} end

print("Telas detectadas: " .. #telas)

-- Configura todas as telas
for i, tela in ipairs(telas) do
    tela.setTextScale(0.5)
end

-- MODOS DE COR dispon√≠veis
local modosCor = {
    ["Branco"] = { cores = {colors.white} },
    ["ColoridoAleatorio"] = {
        cores = { colors.red, colors.orange, colors.yellow, colors.lime, 
                 colors.green, colors.cyan, colors.lightBlue, colors.blue, 
                 colors.purple, colors.pink, colors.magenta }
    },
    ["CorSolida"] = {
        cores = { colors.red, colors.orange, colors.yellow, colors.lime,
                 colors.green, colors.blue, colors.purple, colors.pink }
    }
}

-- VELOCIDADES dispon√≠veis
local velocidades = {
    ["Lenta"] = { multiplicador = 2.0 },
    ["Media"] = { multiplicador = 1.0 },
    ["Rapida"] = { multiplicador = 0.5 },
    ["Eletronica"] = { multiplicador = 0.25 }
}

-- EFEITOS dispon√≠veis
local efeitos = {
    "Pulso Sequencial",
    "Onda", 
    "Respira√ß√£o",
    "Barras Verticais",
    "Pontos Sequenciais",
    "Gradiente",
    "Piscada Aleat√≥ria",
    "Grupos Sequenciais"
}

-- Vari√°veis GLOBAIS de controle
config = {
    modoCor = "Branco",
    velocidade = "Media",
    corSolida = colors.red,
    efeitoAtual = "Pulso Sequencial",
    executando = true,
    precisaAtualizar = true  -- Flag para for√ßar atualiza√ß√£o
}

-- Fun√ß√£o para obter cor
function obterCor(telaIndex)
    if config.modoCor == "Branco" then
        return colors.white
    elseif config.modoCor == "ColoridoAleatorio" then
        return modosCor.ColoridoAleatorio.cores[math.random(1, #modosCor.ColoridoAleatorio.cores)]
    elseif config.modoCor == "CorSolida" then
        return config.corSolida
    end
    return colors.white
end

-- Fun√ß√£o para aplicar velocidade
function aplicarVelocidade(tempoBase)
    return tempoBase * velocidades[config.velocidade].multiplicador
end

-- EFEITOS (agora verificam a flag de atualiza√ß√£o)
function pulsoSequencial()
    local telaAtiva = 1
    
    while config.executando and config.efeitoAtual == "Pulso Sequencial" do
        if config.precisaAtualizar then
            -- Atualiza display
            print("üéµ " .. config.efeitoAtual .. " | üé® " .. config.modoCor .. " | üê¢ " .. config.velocidade)
            config.precisaAtualizar = false
        end
        
        -- Apaga todas
        for i, tela in ipairs(telas) do
            tela.setBackgroundColor(colors.black)
            tela.clear()
        end
        
        -- Acende uma tela
        local cor = obterCor(telaAtiva)
        telas[telaAtiva].setBackgroundColor(cor)
        telas[telaAtiva].clear()
        
        -- Pr√≥xima tela
        telaAtiva = (telaAtiva % #telas) + 1
        sleep(aplicarVelocidade(0.3))
    end
end

function onda()
    local posicao = 0
    
    while config.executando and config.efeitoAtual == "Onda" do
        if config.precisaAtualizar then
            print("üéµ " .. config.efeitoAtual .. " | üé® " .. config.modoCor .. " | üê¢ " .. config.velocidade)
            config.precisaAtualizar = false
        end
        
        posicao = posicao + 1
        
        for i, tela in ipairs(telas) do
            tela.setBackgroundColor(colors.black)
            tela.clear()
            
            if (posicao % #telas) + 1 == i then
                local cor = obterCor(i)
                tela.setBackgroundColor(cor)
                tela.clear()
            end
        end
        
        sleep(aplicarVelocidade(0.2))
    end
end

function respiracao()
    while config.executando and config.efeitoAtual == "Respira√ß√£o" do
        if config.precisaAtualizar then
            print("üéµ " .. config.efeitoAtual .. " | üé® " .. config.modoCor .. " | üê¢ " .. config.velocidade)
            config.precisaAtualizar = false
        end
        
        -- Acende
        local cor = obterCor(1)
        for i, tela in ipairs(telas) do
            tela.setBackgroundColor(cor)
            tela.clear()
        end
        sleep(aplicarVelocidade(0.8))
        
        -- Apaga
        for i, tela in ipairs(telas) do
            tela.setBackgroundColor(colors.black)
            tela.clear()
        end
        sleep(aplicarVelocidade(0.4))
    end
end

function barrasVerticais()
    local offset = 0
    
    while config.executando and config.efeitoAtual == "Barras Verticais" do
        if config.precisaAtualizar then
            print("üéµ " .. config.efeitoAtual .. " | üé® " .. config.modoCor .. " | üê¢ " .. config.velocidade)
            config.precisaAtualizar = false
        end
        
        offset = offset + 1
        
        for i, tela in ipairs(telas) do
            local w, h = tela.getSize()
            tela.setBackgroundColor(colors.black)
            tela.clear()
            
            for barra = 1, 2 do
                local x = (offset + barra * 4 + i * 2) % w + 1
                local cor = obterCor(i)
                
                for y = 1, h do
                    tela.setBackgroundColor(cor)
                    tela.setCursorPos(x, y)
                    tela.write(" ")
                end
            end
        end
        
        sleep(aplicarVelocidade(0.15))
    end
end

-- [Adicione aqui os outros efeitos seguindo o mesmo padr√£o...]

function pontosSequenciais()
    local tempo = 0
    
    while config.executando and config.efeitoAtual == "Pontos Sequenciais" do
        if config.precisaAtualizar then
            print("üéµ " .. config.efeitoAtual .. " | üé® " .. config.modoCor .. " | üê¢ " .. config.velocidade)
            config.precisaAtualizar = false
        end
        
        tempo = tempo + 1
        
        for i, tela in ipairs(telas) do
            local w, h = tela.getSize()
            tela.setBackgroundColor(colors.black)
            tela.clear()
            
            if (tempo % #telas) + 1 == i then
                local x, y = math.floor(w/2), math.floor(h/2)
                local cor = obterCor(i)
                
                tela.setBackgroundColor(cor)
                tela.setCursorPos(x, y)
                tela.write(" ")
                tela.setCursorPos(x+1, y)
                tela.write(" ")
                tela.setCursorPos(x-1, y)
                tela.write(" ")
            end
        end
        
        sleep(aplicarVelocidade(0.25))
    end
end

-- Fun√ß√£o de sleep que verifica se precisa parar
function sleep(tempo)
    local fim = os.clock() + tempo
    while os.clock() < fim do
        if not config.executando or config.precisaAtualizar then
            break
        end
    end
end

-- MENU DE CONTROLE R√ÅPIDO
function menuControle()
    while config.executando do
        print("\n" .. string.rep("=", 50))
        print("üéõÔ∏è  DJ CONTROLLER - CONTROLE R√ÅPIDO")
        print(string.rep("=", 50))
        print("EFEITO ATUAL: " .. config.efeitoAtual)
        print("CONFIG: " .. config.modoCor .. " | " .. config.velocidade)
        print(string.rep("=", 50))
        print("1. üéµ Trocar Efeito")
        print("2. üé® Trocar Cores") 
        print("3. üê¢ Trocar Velocidade")
        print("4. üîÑ Aplicar Configura√ß√£o Atual")
        print("0. üö™ Desligar Sistema")
        print(string.rep("=", 50))
        
        write("Op√ß√£o (1-4, 0=desligar): ")
        local opcao = read()
        
        if opcao == "1" then
            -- Menu de efeitos
            print("\n" .. string.rep("-", 30))
            print("üéµ SELECIONAR EFEITO:")
            for i, efeito in ipairs(efeitos) do
                print(i .. ". " .. efeito)
            end
            print(string.rep("-", 30))
            
            write("Escolha o efeito (1-" .. #efeitos .. "): ")
            local escolha = tonumber(read())
            
            if escolha and escolha >= 1 and escolha <= #efeitos then
                config.efeitoAtual = efeitos[escolha]
                config.precisaAtualizar = true
                print("‚úÖ Novo efeito: " .. config.efeitoAtual)
            else
                print("‚ùå Efeito inv√°lido!")
            end
            
        elseif opcao == "2" then
            -- Menu de cores
            print("\n" .. string.rep("-", 30))
            print("üé® SELECIONAR CORES:")
            print("1. ‚ö™ Branco & Preto")
            print("2. üåà Colorido Aleat√≥rio")
            print("3. üé® Cor S√≥lida")
            print(string.rep("-", 30))
            
            write("Escolha (1-3): ")
            local escolha = read()
            
            if escolha == "1" then
                config.modoCor = "Branco"
                print("‚úÖ Modo: Branco & Preto")
            elseif escolha == "2" then
                config.modoCor = "ColoridoAleatorio" 
                print("‚úÖ Modo: Colorido Aleat√≥rio")
            elseif escolha == "3" then
                config.modoCor = "CorSolida"
                print("üé® Escolha a cor s√≥lida:")
                print("1.üî¥ 2.üü† 3.üü° 4.üü¢ 5.üîµ 6.üü£ 7.üéÄ")
                write("Cor (1-7): ")
                local corEscolha = tonumber(read())
                local cores = {colors.red, colors.orange, colors.yellow, colors.green, colors.blue, colors.purple, colors.pink}
                if corEscolha and corEscolha >=1 and corEscolha <=7 then
                    config.corSolida = cores[corEscolha]
                    print("‚úÖ Cor s√≥lida selecionada!")
                end
            else
                print("‚ùå Op√ß√£o inv√°lida!")
            end
            config.precisaAtualizar = true
            
        elseif opcao == "3" then
            -- Menu de velocidade
            print("\n" .. string.rep("-", 30))
            print("üê¢ SELECIONAR VELOCIDADE:")
            print("1. üê¢ Lenta")
            print("2. üö∂ M√©dia") 
            print("3. üèÉ R√°pida")
            print("4. ‚ö° Eletr√¥nica")
            print(string.rep("-", 30))
            
            write("Escolha (1-4): ")
            local escolha = read()
            
            if escolha == "1" then config.velocidade = "Lenta"
            elseif escolha == "2" then config.velocidade = "Media"
            elseif escolha == "3" then config.velocidade = "Rapida" 
            elseif escolha == "4" then config.velocidade = "Eletronica"
            else print("‚ùå Op√ß√£o inv√°lida!")
            end
            config.precisaAtualizar = true
            
        elseif opcao == "4" then
            config.precisaAtualizar = true
            print("‚úÖ Configura√ß√£o aplicada!")
            
        elseif opcao == "0" then
            config.executando = false
            print("üîÑ Desligando sistema...")
            
        else
            print("‚ùå Op√ß√£o inv√°lida!")
        end
        
        sleep(0.5)  -- Pequena pausa entre menus
    end
end

-- EXECUTOR PRINCIPAL DE EFEITOS
function executarEfeitos()
    while config.executando do
        -- Limpa tudo ao trocar de efeito
        if config.precisaAtualizar then
            for i, tela in ipairs(telas) do
                tela.setBackgroundColor(colors.black)
                tela.clear()
            end
        end
        
        -- Executa o efeito atual
        if config.efeitoAtual == "Pulso Sequencial" then pulsoSequencial()
        elseif config.efeitoAtual == "Onda" then onda()
        elseif config.efeitoAtual == "Respira√ß√£o" then respiracao()
        elseif config.efeitoAtual == "Barras Verticais" then barrasVerticais()
        elseif config.efeitoAtual == "Pontos Sequenciais" then pontosSequenciais()
        -- [Adicione as outras condi√ß√µes aqui...]
        else
            -- Efeito padr√£o se algo der errado
            print("‚ö†Ô∏è  Efeito n√£o encontrado, usando padr√£o")
            config.efeitoAtual = "Pulso Sequencial"
            config.precisaAtualizar = true
        end
    end
end

-- PROGRAMA PRINCIPAL
function main()
    print("üöÄ Iniciando DJ Controller...")
    print("üí° Dica: Use 'Ctrl+T' para emerg√™ncias")
    
    -- Inicia duas threads "paralelas"
    local function iniciarEfeitos()
        pcall(executarEfeitos)
    end
    
    local function iniciarControle()
        pcall(menuControle)
    end
    
    -- Executa ambas (em pseudo-paralelismo)
    iniciarEfeitos()
    -- Esta linha s√≥ executa quando os efeitos param
    
    -- Limpeza final
    print("üßπ Limpando telas...")
    for i, tela in ipairs(telas) do
        tela.setBackgroundColor(colors.black)
        tela.clear()
    end
    print("‚úÖ Sistema desligado!")
end

-- INICIAR
main()
