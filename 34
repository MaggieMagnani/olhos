-- =============================================
-- OLHO ÚNICO GIGANTE - TRANSição ENTRE TELAS
-- =============================================

print("=== INICIANDO OLHO ÚNICO GIGANTE ===")

-- Pega TODAS as telas
local telas = {peripheral.find("monitor")}
if not telas[1] then telas = {telas} end

print("Telas detectadas: " .. #telas)

-- Configura todas as telas
for i, tela in ipairs(telas) do
    tela.setTextScale(0.5)
    tela.setBackgroundColor(colors.black)
    tela.clear()
end

-- Sistema de transição entre telas
local tempo = 0
local telaAtual = 1
local posXTela, posYTela = 4, 3  -- Posição central dentro de cada tela

-- Organizar telas em posições virtuais
function organizarTelas()
    print("Organizando " .. #telas .. " telas para movimento...")
    
    -- Criar um caminho entre as telas
    local telasPorLinha = math.min(6, math.ceil(math.sqrt(#telas)))
    
    for i, tela in ipairs(telas) do
        tela.numero = i
        tela.largura = 8
        tela.altura = 5
        
        -- Calcular posição no grid (apenas para lógica de movimento)
        local linha = math.floor((i - 1) / telasPorLinha)
        local coluna = (i - 1) % telasPorLinha
        tela.linha = linha
        tela.coluna = coluna
    end
    
    print("Grid: " .. telasPorLinha .. " telas por linha")
end

-- Limpar TODAS as telas
function limparTodasTelas()
    for i, tela in ipairs(telas) do
        tela.setBackgroundColor(colors.black)
        tela.clear()
    end
end

-- Desenhar olho GIGANTE em uma tela específica
function desenharOlhoGigante(tela, x, y)
    -- Olho GIGANTE (6x4 pixels) - ocupa boa parte da tela
    -- Branco do olho
    for dx = -3, 2 do
        for dy = -2, 1 do
            local px, py = x + dx, y + dy
            if px >= 1 and px <= tela.largura and py >= 1 and py <= tela.altura then
                tela.setBackgroundColor(colors.white)
                tela.setCursorPos(px, py)
                tela.write(" ")
            end
        end
    end
    
    -- Íris azul (4x2 pixels)
    for dx = -2, 1 do
        for dy = -1, 0 do
            local px, py = x + dx, y + dy
            if px >= 1 and px <= tela.largura and py >= 1 and py <= tela.altura then
                tela.setBackgroundColor(colors.blue)
                tela.setCursorPos(px, py)
                tela.write(" ")
            end
        end
    end
    
    -- Pupila preta (2x1 pixels)
    for dx = -1, 0 do
        local px, py = x + dx, y
        if px >= 1 and px <= tela.largura and py >= 1 and py <= tela.altura then
            tela.setBackgroundColor(colors.black)
            tela.setCursorPos(px, py)
            tela.write(" ")
        end
    end
    
    -- Brilhos
    local px, py = x - 1, y - 1
    if px >= 1 and px <= tela.largura and py >= 1 and py <= tela.altura then
        tela.setBackgroundColor(colors.lightBlue)
        tela.setCursorPos(px, py)
        tela.write(" ")
    end
    
    px, py = x, y - 1
    if px >= 1 and px <= tela.largura and py >= 1 and py <= tela.altura then
        tela.setBackgroundColor(colors.white)
        tela.setCursorPos(px, py)
        tela.write(" ")
    end
end

-- Desenhar olho MEGA GIGANTE (ainda maior)
function desenharOlhoMegaGigante(tela, x, y)
    -- Olho MEGA GIGANTE (7x5 pixels) - quase ocupa tela toda
    -- Branco do olho
    for dx = -3, 3 do
        for dy = -2, 2 do
            local px, py = x + dx, y + dy
            if px >= 1 and px <= tela.largura and py >= 1 and py <= tela.altura then
                tela.setBackgroundColor(colors.white)
                tela.setCursorPos(px, py)
                tela.write(" ")
            end
        end
    end
    
    -- Íris azul (5x3 pixels)
    for dx = -2, 2 do
        for dy = -1, 1 do
            local px, py = x + dx, y + dy
            if px >= 1 and px <= tela.largura and py >= 1 and py <= tela.altura then
                tela.setBackgroundColor(colors.blue)
                tela.setCursorPos(px, py)
                tela.write(" ")
            end
        end
    end
    
    -- Pupila preta (3x2 pixels)
    for dx = -1, 1 do
        for dy = 0, 1 do
            local px, py = x + dx, y + dy
            if px >= 1 and px <= tela.largura and py >= 1 and py <= tela.altura then
                tela.setBackgroundColor(colors.black)
                tela.setCursorPos(px, py)
                tela.write(" ")
            end
        end
    end
    
    -- Brilhos múltiplos
    local brilhos = {
        {x-2, y-2, colors.lightBlue},
        {x-1, y-2, colors.lightBlue},
        {x+1, y-1, colors.white},
        {x+2, y-2, colors.white}
    }
    
    for _, brilho in ipairs(brilhos) do
        local px, py, cor = brilho[1], brilho[2], brilho[3]
        if px >= 1 and px <= tela.largura and py >= 1 and py <= tela.altura then
            tela.setBackgroundColor(cor)
            tela.setCursorPos(px, py)
            tela.write(" ")
        end
    end
end

-- Movimento: visita ordenada (uma tela por vez)
function movimentoVisitaOrdenada(t)
    -- Mudar de tela a cada 3 segundos
    local tempoPorTela = 3.0
    local novaTela = (math.floor(t / tempoPorTela) % #telas) + 1
    
    -- Posição central na tela
    local x = math.floor(telas[novaTela].largura / 2)
    local y = math.floor(telas[novaTela].altura / 2)
    
    return novaTela, x, y
end

-- Movimento: caminho em zigue-zague
function movimentoZigueZague(t)
    local telasPorLinha = 6
    local tempoPorTela = 2.5
    
    local telaIndex = (math.floor(t / tempoPorTela) % #telas) + 1
    local linha = math.floor((telaIndex - 1) / telasPorLinha)
    local coluna = (telaIndex - 1) % telasPorLinha
    
    -- Em linhas pares, inverte a direção
    if linha % 2 == 1 then
        coluna = telasPorLinha - 1 - coluna
    end
    
    local novaTela = linha * telasPorLinha + coluna + 1
    if novaTela > #telas then novaTela = #telas end
    
    local x = math.floor(telas[novaTela].largura / 2)
    local y = math.floor(telas[novaTela].altura / 2)
    
    return novaTela, x, y
end

-- Movimento: espiral pelas telas
function movimentoEspiral(t)
    local tempoPorTela = 2.0
    local telaIndex = (math.floor(t / tempoPorTela) % #telas) + 1
    
    -- Criar ordem em espiral
    local ordemEspiral = {}
    local telasPorLinha = 6
    
    -- Preencher ordem em espiral (simplificado)
    for i = 1, #telas do
        table.insert(ordemEspiral, i)
    end
    
    local novaTela = ordemEspiral[telaIndex]
    local x = math.floor(telas[novaTela].largura / 2)
    local y = math.floor(telas[novaTela].altura / 2)
    
    return novaTela, x, y
end

-- Movimento: aleatório suave
function movimentoAleatorioSuave(t)
    -- Mudar de tela a cada 4 segundos
    local tempoPorTela = 4.0
    local novaTela = (math.floor(t / tempoPorTela) % #telas) + 1
    
    -- Posição levemente aleatória mas centralizada
    local x = math.random(3, telas[novaTela].largura - 2)
    local y = math.random(2, telas[novaTela].altura - 2)
    
    return novaTela, x, y
end

-- Animação principal
function executarAnimacao()
    local modosMovimento = {
        movimentoVisitaOrdenada,
        movimentoZigueZague,
        movimentoEspiral,
        movimentoAleatorioSuave
    }
    
    local nomesModos = {
        "Visita Ordenada",
        "Zigue-Zague",
        "Espiral",
        "Aleatório Suave"
    }
    
    local modoAtual = 1
    local ultimaTrocaModo = os.time()
    local ultimaTela = telaAtual
    
    print("\n=== OLHO ÚNICO GIGANTE ===")
    print("Modo: " .. nomesModos[modoAtual])
    print("Tamanho: 7x5 pixels (MEGA GIGANTE)")
    print("Pressione Ctrl+T para parar")
    print("==========================\n")
    
    while true do
        -- Trocar modo a cada 60 segundos
        if os.time() - ultimaTrocaModo > 60 then
            modoAtual = (modoAtual % #modosMovimento) + 1
            ultimaTrocaModo = os.time()
            print("Mudando para modo: " .. nomesModos[modoAtual])
        end
        
        -- Calcular nova posição
        local novaTela, x, y = modosMovimento[modoAtual](tempo)
        
        -- Se mudou de tela, limpar a tela anterior
        if novaTela ~= ultimaTela then
            if telas[ultimaTela] then
                telas[ultimaTela].setBackgroundColor(colors.black)
                telas[ultimaTela].clear()
            end
            ultimaTela = novaTela
            print("Olho movendo para tela " .. novaTela)
        end
        
        telaAtual = novaTela
        posXTela, posYTela = x, y
        
        -- Limpar apenas a tela atual (para evitar piscar)
        telas[telaAtual].setBackgroundColor(colors.black)
        telas[telaAtual].clear()
        
        -- Desenhar o olho GIGANTE na tela atual
        if math.sin(tempo * 1.5) > 0 then
            desenharOlhoGigante(telas[telaAtual], posXTela, posYTela)
        else
            desenharOlhoMegaGigante(telas[telaAtual], posXTela, posYTela)
        end
        
        tempo = tempo + 0.1
        os.sleep(0.15)
    end
end

-- Programa principal
if #telas == 0 then
    print("ERRO: Nenhuma tela detectada!")
else
    math.randomseed(os.time())
    organizarTelas()
    executarAnimacao()
end
